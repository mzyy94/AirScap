<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>airscap</title>
  <link rel="stylesheet" href="bulma.min.css">
  <script defer src="alpine.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
    }
    .status-row + .status-row {
      border-top: 1px solid #f0f0f0;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 8rem 1fr;
      gap: 0.4rem 1rem;
      font-size: 0.875rem;
    }
    .info-grid dt { color: #7a7a7a; }
    .info-grid dd { font-weight: 500; word-break: break-all; }
    .escl-url {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.875rem;
      background: #f5f5f5;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      word-break: break-all;
    }
    .spinner {
      display: inline-block;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      width: 2rem;
      height: 2rem;
      border-width: 3px;
      border-top-color: #485fc7;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .tag-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body x-data="app()" x-init="init()">
  <!-- Header -->
  <nav class="navbar is-dark px-5" role="navigation">
    <div class="navbar-brand is-flex-grow-1 is-justify-content-space-between">
      <span class="navbar-item has-text-white is-size-5 has-text-weight-semibold" style="letter-spacing: 0.05em;">airscap</span>
      <div class="navbar-item">
        <span x-cloak x-show="status?.online" class="tag is-success is-rounded tag-pulse">Online</span>
        <span x-cloak x-show="status && !status.online" class="tag is-danger is-rounded">Offline</span>
        <span x-show="!status" class="tag is-rounded is-skeleton">Loading</span>
      </div>
    </div>
  </nav>

  <div class="container is-max-tablet py-4">
      <!-- Loading -->
      <div class="has-text-centered py-6" x-show="!status">
        <span class="spinner"></span>
      </div>

      <!-- Connection Status -->
      <div class="card mb-4" x-cloak x-show="status">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>
          </span>
          <p class="card-header-title">ステータス</p>
        </header>
        <div class="card-content">

          <div x-show="status && !status.online" x-transition class="notification is-warning is-light mb-4 py-3 px-4">
            <div class="is-flex is-align-items-start" style="gap: 0.5rem;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0; margin-top:2px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span class="is-size-7">スキャナーとの接続が切れています。再接続を試みています...</span>
            </div>
          </div>

          <div class="status-row">
            <span class="is-size-7 has-text-grey">接続</span>
            <span class="tag is-rounded"
              :class="status?.online ? 'is-success' : 'is-danger'"
              x-text="status?.online ? 'Online' : 'Offline'">
            </span>
          </div>
          <div class="status-row" x-show="status?.adf != null">
            <span class="is-size-7 has-text-grey">ADF</span>
            <span class="tag is-rounded"
              :class="status?.adf?.loaded ? 'is-primary' : 'is-light'"
              x-text="status?.adf?.loaded ? '用紙あり' : '用紙なし'">
            </span>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">最終更新</span>
            <span class="is-size-7 has-text-grey-light" x-text="relativeTime(status?.updatedAt, tick)"></span>
          </div>
        </div>
      </div>

      <!-- Device Info -->
      <div class="card mb-4" x-cloak x-show="status?.device">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></span>
          </span>
          <p class="card-header-title">デバイス情報</p>
        </header>
        <div class="card-content">
          <dl class="info-grid">
            <dt>名前</dt>
            <dd x-text="status?.device?.name || '-'"></dd>
            <dt>シリアル</dt>
            <dd x-text="status?.device?.serial || '-'"></dd>
            <dt>IP アドレス</dt>
            <dd x-text="status?.device?.host || '-'"></dd>
            <dt>メーカー</dt>
            <dd x-text="status?.device?.manufacturer || '-'"></dd>
            <dt>F/W リビジョン</dt>
            <dd x-text="status?.device?.firmwareRevision || '-'"></dd>
          </dl>
        </div>
      </div>

      <!-- Capabilities -->
      <div class="card mb-4" x-cloak x-show="status?.capabilities">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg></span>
          </span>
          <p class="card-header-title">スキャン機能</p>
        </header>
        <div class="card-content">
          <div class="status-row">
            <span class="is-size-7 has-text-grey">解像度</span>
            <div class="tags mb-0">
              <template x-for="r in (status?.capabilities?.resolutions || [])">
                <span class="tag is-light is-rounded" x-text="resLabel(r)"></span>
              </template>
            </div>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">カラー</span>
            <div class="tags mb-0">
              <template x-for="m in (status?.capabilities?.colorModes || [])">
                <span class="tag is-light is-rounded" x-text="modeLabel(m)"></span>
              </template>
            </div>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">両面</span>
            <span class="tag is-rounded"
              :class="status?.capabilities?.duplex ? 'is-success' : 'is-light'"
              x-text="status?.capabilities?.duplex ? '対応' : '非対応'">
            </span>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">出力形式</span>
            <div class="tags mb-0">
              <template x-for="f in (status?.capabilities?.formats || [])">
                <span class="tag is-light is-rounded" x-text="formatLabel(f)"></span>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Default Settings -->
      <div class="card mb-4" x-cloak x-show="settingsReady">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></span>
          </span>
          <p class="card-header-title">スキャン設定</p>
          <span class="card-header-icon" style="gap: 0.25rem;">
            <span x-cloak x-show="settingsSaved" x-transition.opacity class="tag is-success is-light is-rounded is-size-7">保存済み</span>
            <span x-cloak x-show="settingsError" x-transition.opacity class="tag is-danger is-light is-rounded is-size-7">保存失敗</span>
          </span>
        </header>
        <div class="card-content">

          <div class="field">
            <label class="label is-small">カラーモード</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select x-model="scanConfig.colorMode" @change="onColorModeChange()">
                  <template x-for="m in (status?.capabilities?.colorModes || [])">
                    <option :value="m" x-text="modeLabel(m)"></option>
                  </template>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label is-small">解像度</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select x-model="scanConfig.resolution" @change="debounceSaveSettings()">
                  <template x-for="r in (status?.capabilities?.resolutions || [])">
                    <option :value="String(r)" x-text="resLabel(r)"></option>
                  </template>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label is-small">出力形式</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select x-model="scanConfig.format" @change="debounceSaveSettings()">
                  <template x-for="f in availableFormats">
                    <option :value="f" x-text="formatLabel(f)"></option>
                  </template>
                </select>
              </div>
            </div>
          </div>

          <div class="field" x-show="status?.capabilities?.duplex">
            <div class="buttons has-addons">
              <button type="button" class="button" :class="!scanConfig.duplex ? 'is-primary is-selected' : ''" @click="scanConfig.duplex = false; debounceSaveSettings()">片面スキャン</button>
              <button type="button" class="button" :class="scanConfig.duplex ? 'is-primary is-selected' : ''" @click="scanConfig.duplex = true; debounceSaveSettings()">両面スキャン</button>
            </div>
          </div>

        </div>
      </div>

      <!-- Save Destination -->
      <div class="card mb-4" x-cloak x-show="settingsReady">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></span>
          </span>
          <p class="card-header-title">保存先</p>
          <span class="card-header-icon" style="gap: 0.25rem;">
            <span x-cloak x-show="settingsSaved" x-transition.opacity class="tag is-success is-light is-rounded is-size-7">保存済み</span>
            <span x-cloak x-show="settingsError" x-transition.opacity class="tag is-danger is-light is-rounded is-size-7">保存失敗</span>
          </span>
        </header>
        <div class="card-content">

          <div class="tabs is-toggle is-centered mb-4">
            <ul>
              <li :class="scanConfig.saveType === 'none' ? 'is-active' : ''">
                <a @click="scanConfig.saveType = 'none'; debounceSaveSettings()">
                  <span>保存しない</span>
                </a>
              </li>
              <li :class="scanConfig.saveType === 'local' ? 'is-active' : ''">
                <a @click="scanConfig.saveType = 'local'; debounceSaveSettings()">
                  <span class="icon is-small"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></span>
                  <span>ローカルフォルダ</span>
                </a>
              </li>
              <li :class="scanConfig.saveType === 'ftp' ? 'is-active' : ''">
                <a @click="scanConfig.saveType = 'ftp'; debounceSaveSettings()">
                  <span class="icon is-small"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg></span>
                  <span>FTP</span>
                </a>
              </li>
              <li :class="scanConfig.saveType === 'paperless' ? 'is-active' : ''">
                <a @click="scanConfig.saveType = 'paperless'; debounceSaveSettings()">
                  <span class="icon is-small"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></span>
                  <span>Paperless-ngx</span>
                </a>
              </li>
            </ul>
          </div>

          <div x-show="scanConfig.saveType === 'local'" x-transition>
            <div class="field">
              <label class="label is-small">保存ディレクトリ</label>
              <div class="control">
                <input class="input" type="text" x-model="scanConfig.savePath"
                  placeholder="/path/to/scans" @change="debounceSaveSettings()">
              </div>
              <p class="help">スキャナのボタンを押した時にファイルを保存するディレクトリ</p>
            </div>
          </div>

          <div x-show="scanConfig.saveType === 'ftp'" x-transition>
            <div class="field">
              <label class="label is-small">FTP アドレス</label>
              <div class="control">
                <input class="input" type="text" x-model="scanConfig.ftpHost"
                  placeholder="ftp.example.com:21" @change="debounceSaveSettings()">
              </div>
              <p class="help">ホスト名:ポート（ポート省略時は 21）</p>
            </div>
            <div class="field">
              <label class="label is-small">ユーザー名</label>
              <div class="control">
                <input class="input" type="text" x-model="scanConfig.ftpUser"
                  placeholder="anonymous" @change="debounceSaveSettings()">
              </div>
            </div>
            <div class="field">
              <label class="label is-small">パスワード</label>
              <div class="control">
                <input class="input" type="password" x-model="scanConfig.ftpPassword"
                  @change="debounceSaveSettings()">
              </div>
            </div>
          </div>

          <div x-show="scanConfig.saveType === 'paperless'" x-transition>
            <div class="field">
              <label class="label is-small">Paperless-ngx URL</label>
              <div class="control">
                <input class="input" type="text" x-model="scanConfig.paperlessUrl"
                  placeholder="http://paperless.local:8000" @change="debounceSaveSettings()">
              </div>
              <p class="help">Paperless-ngx のベース URL</p>
            </div>
            <div class="field">
              <label class="label is-small">API トークン</label>
              <div class="control">
                <input class="input" type="password" x-model="scanConfig.paperlessToken"
                  @change="debounceSaveSettings()">
              </div>
              <p class="help">設定 > API トークン から取得</p>
            </div>
          </div>

        </div>
      </div>

      <!-- Scan Job Status -->
      <div class="card mb-4" x-cloak x-show="scanJob.scanning || scanJob.lastScan">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></span>
          </span>
          <p class="card-header-title">スキャン</p>
        </header>
        <div class="card-content">
          <template x-if="scanJob.scanning">
            <div class="is-flex is-align-items-center" style="gap: 0.75rem;">
              <span class="spinner" style="width:1.5rem; height:1.5rem; border-width:2px;"></span>
              <span class="is-size-7">スキャン中...</span>
            </div>
          </template>
          <template x-if="!scanJob.scanning && scanJob.lastScan && !scanJob.lastError">
            <div>
              <span class="tag is-success is-light is-rounded" x-text="scanJob.pages + ' ページ保存完了'"></span>
              <span class="is-size-7 has-text-grey-light ml-2" x-text="relativeTime(scanJob.lastScan, tick)"></span>
            </div>
          </template>
          <template x-if="!scanJob.scanning && scanJob.lastError">
            <div>
              <span class="tag is-danger is-light is-rounded">スキャン失敗</span>
              <span class="is-size-7 has-text-grey ml-2" x-text="scanJob.lastError"></span>
            </div>
          </template>
        </div>
      </div>

      <!-- eSCL Endpoint -->
      <div class="card mb-4" x-cloak x-show="status?.esclUrl">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
          </span>
          <p class="card-header-title">eSCL エンドポイント</p>
        </header>
        <div class="card-content">
          <div class="escl-url" x-text="status?.esclUrl"></div>
          <p class="is-size-7 has-text-grey-light mt-2">
            SANE / macOS Image Capture / Windows WSD から利用できます
          </p>
        </div>
      </div>
  </div>

  <script>
    function app() {
      return {
        status: null,
        tick: 0,
        scanConfig: { colorMode: 'auto', resolution: '0', duplex: false, format: 'application/pdf', saveType: 'none', savePath: '', ftpHost: '', ftpUser: '', ftpPassword: '', paperlessUrl: '', paperlessToken: '' },
        scanJob: { scanning: false, lastError: '', lastScan: '', pages: 0, filePath: '' },
        settingsReady: false,
        settingsSaved: false,
        settingsError: false,
        _saveTimer: null,

        async init() {
          await this.refresh();
          await this.$nextTick();
          await this.loadSettings();
          setInterval(() => { this.refresh(); this.refreshScanStatus(); }, 3000);
          setInterval(() => this.tick++, 1000);
        },

        async refresh() {
          try {
            const resp = await fetch('api/status');
            if (resp.ok) {
              this.status = await resp.json();
            }
          } catch (e) {
            console.error('status fetch failed', e);
            if (this.status) {
              this.status = { ...this.status, online: false, state: 'offline' };
            }
          }
        },

        async loadSettings() {
          try {
            const resp = await fetch('api/settings');
            if (!resp.ok) return;
            const s = await resp.json();
            this.scanConfig = {
              colorMode: s.colorMode || 'auto',
              resolution: String(s.resolution ?? 0),
              duplex: s.duplex || false,
              format: s.format || 'application/pdf',
              saveType: s.saveType || 'none',
              savePath: s.savePath || '',
              ftpHost: s.ftpHost || '',
              ftpUser: s.ftpUser || '',
              ftpPassword: s.ftpPassword || '',
              paperlessUrl: s.paperlessUrl || '',
              paperlessToken: s.paperlessToken || '',
            };
            this.clampToCapabilities();
            this.settingsReady = true;
          } catch (e) {
            console.error('settings load failed', e);
          }
        },

        clampToCapabilities() {
          const caps = this.status?.capabilities;
          if (!caps) return;
          const res = caps.resolutions || [];
          if (res.length && !res.includes(Number(this.scanConfig.resolution))) {
            this.scanConfig.resolution = String(res[res.length - 1]);
          }
          const modes = caps.colorModes || [];
          if (modes.length && !modes.includes(this.scanConfig.colorMode)) {
            this.scanConfig.colorMode = modes[0];
          }
          const fmts = caps.formats || [];
          if (fmts.length && !fmts.includes(this.scanConfig.format)) {
            this.scanConfig.format = fmts[0];
          }
          if (!caps.duplex) {
            this.scanConfig.duplex = false;
          }
        },

        debounceSaveSettings() {
          clearTimeout(this._saveTimer);
          this._saveTimer = setTimeout(() => this.saveSettings(), 500);
        },

        async saveSettings() {
          try {
            const body = {
              colorMode: this.scanConfig.colorMode,
              resolution: Number(this.scanConfig.resolution),
              duplex: this.scanConfig.duplex,
              format: this.scanConfig.format,
              saveType: this.scanConfig.saveType,
              savePath: this.scanConfig.savePath,
              ftpHost: this.scanConfig.ftpHost,
              ftpUser: this.scanConfig.ftpUser,
              ftpPassword: this.scanConfig.ftpPassword,
              paperlessUrl: this.scanConfig.paperlessUrl,
              paperlessToken: this.scanConfig.paperlessToken,
            };
            const resp = await fetch('api/settings', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            if (resp.ok) {
              this.settingsError = false;
              this.settingsSaved = true;
              setTimeout(() => this.settingsSaved = false, 2000);
            } else {
              this.settingsError = true;
              setTimeout(() => this.settingsError = false, 3000);
            }
          } catch (e) {
            console.error('settings save failed', e);
            this.settingsError = true;
            setTimeout(() => this.settingsError = false, 3000);
          }
        },

        async refreshScanStatus() {
          try {
            const resp = await fetch('api/scan/status');
            if (resp.ok) {
              const data = await resp.json();
              this.scanJob.scanning = data.scanning ?? false;
              this.scanJob.lastError = data.lastError ?? '';
              this.scanJob.lastScan = data.lastScan ?? '';
              this.scanJob.pages = data.pages ?? 0;
              this.scanJob.filePath = data.filePath ?? '';
            }
          } catch (e) {
            // ignore
          }
        },

        resLabel(r) {
          return r === 0 ? '自動' : r + ' dpi';
        },

        modeLabel(mode) {
          return { auto: '自動', color: 'カラー', grayscale: 'グレースケール', bw: '白黒' }[mode] || mode;
        },

        get availableFormats() {
          if (this.scanConfig.colorMode === 'bw') {
            return ['application/pdf', 'image/tiff'];
          }
          return ['application/pdf', 'image/jpeg'];
        },

        onColorModeChange() {
          if (!this.availableFormats.includes(this.scanConfig.format)) {
            this.scanConfig.format = 'application/pdf';
          }
          this.debounceSaveSettings();
        },

        formatLabel(fmt) {
          return {
            'application/pdf': 'PDF',
            'image/jpeg': 'JPEG',
            'image/tiff': 'TIFF'
          }[fmt] || fmt;
        },

        relativeTime(isoStr, _tick) {
          if (!isoStr) return '';
          const seconds = Math.floor((Date.now() - new Date(isoStr).getTime()) / 1000);
          if (seconds < 10) return 'たった今';
          if (seconds < 60) return `${seconds}秒前`;
          if (seconds < 3600) return `${Math.floor(seconds / 60)}分前`;
          return new Date(isoStr).toLocaleTimeString('ja-JP');
        },
      };
    }
  </script>
</body>
</html>
