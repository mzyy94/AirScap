<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>airscap</title>
  <link rel="stylesheet" href="bulma.min.css">
  <script defer src="alpine.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
    }
    .status-row + .status-row {
      border-top: 1px solid #f0f0f0;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 6rem 1fr;
      gap: 0.4rem 1rem;
      font-size: 0.875rem;
    }
    .info-grid dt { color: #7a7a7a; }
    .info-grid dd { font-weight: 500; word-break: break-all; }
    .escl-url {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.875rem;
      background: #f5f5f5;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      word-break: break-all;
    }
    .spinner {
      display: inline-block;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      width: 2rem;
      height: 2rem;
      border-width: 3px;
      border-top-color: #485fc7;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .tag-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body x-data="app()" x-init="init()">
  <!-- Header -->
  <nav class="navbar is-dark px-5" role="navigation">
    <div class="navbar-brand is-flex-grow-1 is-justify-content-space-between">
      <span class="navbar-item has-text-white is-size-5 has-text-weight-semibold" style="letter-spacing: 0.05em;">airscap</span>
      <div class="navbar-item">
        <span x-cloak x-show="status?.online" class="tag is-success is-rounded tag-pulse">Online</span>
        <span x-cloak x-show="status && !status.online" class="tag is-danger is-rounded">Offline</span>
        <span x-show="!status" class="tag is-rounded is-skeleton">Loading</span>
      </div>
    </div>
  </nav>

  <div class="container is-max-tablet py-4">
      <!-- Loading -->
      <div class="has-text-centered py-6" x-show="!status">
        <span class="spinner"></span>
      </div>

      <!-- Connection Status -->
      <div class="card mb-4" x-cloak x-show="status">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>
          </span>
          <p class="card-header-title">ステータス</p>
        </header>
        <div class="card-content">

          <div x-show="status && !status.online" x-transition class="notification is-warning is-light mb-4 py-3 px-4">
            <div class="is-flex is-align-items-start" style="gap: 0.5rem;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0; margin-top:2px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span class="is-size-7">スキャナーとの接続が切れています。再接続を試みています...</span>
            </div>
          </div>

          <div class="status-row">
            <span class="is-size-7 has-text-grey">接続</span>
            <span class="tag is-rounded"
              :class="status?.online ? 'is-success' : 'is-danger'"
              x-text="status?.online ? 'Online' : 'Offline'">
            </span>
          </div>
          <div class="status-row" x-show="status?.adf != null">
            <span class="is-size-7 has-text-grey">ADF</span>
            <span class="tag is-rounded"
              :class="status?.adf?.loaded ? 'is-primary' : 'is-light'"
              x-text="status?.adf?.loaded ? '用紙あり' : '用紙なし'">
            </span>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">最終更新</span>
            <span class="is-size-7 has-text-grey-light" x-text="relativeTime(status?.updatedAt)"></span>
          </div>
        </div>
      </div>

      <!-- Device Info -->
      <div class="card mb-4" x-cloak x-show="status?.device">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></span>
          </span>
          <p class="card-header-title">デバイス情報</p>
        </header>
        <div class="card-content">
          <dl class="info-grid">
            <dt>名前</dt>
            <dd x-text="status?.device?.name || '-'"></dd>
            <dt>シリアル</dt>
            <dd x-text="status?.device?.serial || '-'"></dd>
            <dt>IP アドレス</dt>
            <dd x-text="status?.device?.host || '-'"></dd>
            <dt>メーカー</dt>
            <dd x-text="status?.device?.manufacturer || '-'"></dd>
          </dl>
        </div>
      </div>

      <!-- Capabilities -->
      <div class="card mb-4" x-cloak x-show="status?.capabilities">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg></span>
          </span>
          <p class="card-header-title">スキャン機能</p>
        </header>
        <div class="card-content">
          <div class="status-row">
            <span class="is-size-7 has-text-grey">解像度</span>
            <div class="tags mb-0">
              <template x-for="r in (status?.capabilities?.resolutions || [])">
                <span class="tag is-light is-rounded" x-text="r + ' dpi'"></span>
              </template>
            </div>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">カラー</span>
            <div class="tags mb-0">
              <template x-for="m in (status?.capabilities?.colorModes || [])">
                <span class="tag is-light is-rounded" x-text="modeLabel(m)"></span>
              </template>
            </div>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">両面</span>
            <span class="tag is-rounded"
              :class="status?.capabilities?.duplex ? 'is-success' : 'is-light'"
              x-text="status?.capabilities?.duplex ? '対応' : '非対応'">
            </span>
          </div>
          <div class="status-row">
            <span class="is-size-7 has-text-grey">出力形式</span>
            <div class="tags mb-0">
              <template x-for="f in (status?.capabilities?.formats || [])">
                <span class="tag is-light is-rounded" x-text="formatLabel(f)"></span>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- eSCL Endpoint -->
      <div class="card mb-4" x-cloak x-show="status?.esclUrl">
        <header class="card-header">
          <span class="card-header-icon">
            <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
          </span>
          <p class="card-header-title">eSCL エンドポイント</p>
        </header>
        <div class="card-content">
          <div class="escl-url" x-text="status?.esclUrl"></div>
          <p class="is-size-7 has-text-grey-light mt-2">
            SANE / macOS Image Capture / Windows WSD から利用できます
          </p>
        </div>
      </div>
  </div>

  <script>
    function app() {
      return {
        status: null,

        async init() {
          await this.refresh();
          setInterval(() => this.refresh(), 3000);
        },

        async refresh() {
          try {
            const resp = await fetch('api/status');
            if (resp.ok) {
              this.status = await resp.json();
            }
          } catch (e) {
            console.error('status fetch failed', e);
          }
        },

        modeLabel(mode) {
          return { color: 'カラー', grayscale: 'グレースケール', bw: '白黒' }[mode] || mode;
        },

        formatLabel(fmt) {
          return {
            'application/pdf': 'PDF',
            'image/jpeg': 'JPEG',
            'image/tiff': 'TIFF'
          }[fmt] || fmt;
        },

        relativeTime(isoStr) {
          if (!isoStr) return '';
          const seconds = Math.floor((Date.now() - new Date(isoStr).getTime()) / 1000);
          if (seconds < 10) return 'たった今';
          if (seconds < 60) return `${seconds}秒前`;
          if (seconds < 3600) return `${Math.floor(seconds / 60)}分前`;
          return new Date(isoStr).toLocaleTimeString('ja-JP');
        },
      };
    }
  </script>
</body>
</html>
